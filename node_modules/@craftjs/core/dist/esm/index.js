"undefined"!=typeof window&&(window.__CRAFTJS__||(window.__CRAFTJS__={}),window.__CRAFTJS__["@craftjs/core"]="0.2.10");import{ERROR_USE_EDITOR_OUTSIDE_OF_EDITOR_CONTEXT as e,useCollector as t,wrapConnectorHooks as n,ERROR_USE_NODE_OUTSIDE_OF_EDITOR_CONTEXT as r,deprecationWarning as o,ERROR_TOP_LEVEL_ELEMENT_NO_ID as a,ROOT_NODE as i,ERROR_INVALID_NODEID as s,ERROR_DELETE_TOP_LEVEL_NODE as d,ERROR_NOPARENT as c,DEPRECATED_ROOT_NODE as u,ERROR_NOT_IN_RESOLVER as l,ERROR_INVALID_NODE_ID as f,ERROR_MOVE_TOP_LEVEL_NODE as p,ERROR_MOVE_NONCANVAS_CHILD as v,ERROR_CANNOT_DRAG as h,ERROR_MOVE_TO_NONCANVAS_PARENT as y,ERROR_MOVE_INCOMING_PARENT as g,ERROR_MOVE_CANNOT_DROP as m,ERROR_MOVE_TO_DESCENDANT as N,ERROR_DUPLICATE_NODEID as b,ERROR_MOVE_OUTGOING_PARENT as E,getRandomId as O,ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER as w,getDOMInfo as T,EventHandlers as C,DerivedEventHandlers as k,isChromium as S,isLinux as j,RenderIndicator as D,useMethods as I,ERROR_RESOLVER_NOT_AN_OBJECT as x,HISTORY_ACTIONS as P}from"@craftjs/utils";export{ROOT_NODE}from"@craftjs/utils";import A,{createContext as L,useContext as R,useMemo as q,useEffect as _,useState as F,useRef as M,Children as z,Fragment as B}from"react";import H from"tiny-invariant";import $ from"lodash/isFunction";import J from"lodash/cloneDeep";const W=A.createContext(null),U=({id:e,related:t=!1,children:n})=>A.createElement(W.Provider,{value:{id:e,related:t}},n);function V(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function X(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?V(Object(n),!0).forEach((function(t){Z(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):V(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Y(e){return Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Y(e)}function G(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function K(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ue(r.key),r)}}function Q(e,t,n){return t&&K(e.prototype,t),n&&K(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Z(e,t,n){return(t=ue(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ee(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ne(e,t)}function te(e){return te=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},te(e)}function ne(e,t){return ne=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ne(e,t)}function re(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t.indexOf(n=a[r])>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t.indexOf(n=a[r])>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function oe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=te(e);if(t){var o=te(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return oe(e)}(this,n)}}function ie(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],d=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;d=!1}else for(;!(d=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);d=!0);}catch(e){c=!0,o=e}finally{try{if(!d&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(c)throw o}}return s}}(e,t)||de(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function se(e){return function(e){if(Array.isArray(e))return ce(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||de(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function de(e,t){if(e){if("string"==typeof e)return ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ce(e,t):void 0}}function ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ue(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}const le=L(null);var fe=L(null),pe=function(){return R(fe)};function ve(r){var o=pe(),a=R(le);H(a,e);var i=t(a,r),s=q((function(){return o&&o.createConnectorsUsage()}),[o]);_((function(){return s.register(),function(){s.cleanup()}}),[s]);var d=q((function(){return s&&n(s.connectors)}),[s]);return X(X({},i),{},{connectors:d,inContext:!!a,store:a})}var he=["actions","query","connectors"];function ye(e){var t=R(W);H(t,r);var o=t.id,a=t.related,i=ve((function(t){return o&&t.nodes[o]&&e&&e(t.nodes[o])})),s=i.actions,d=i.connectors,c=re(i,he),u=q((function(){return n({connect:function(e){return d.connect(e,o)},drag:function(e){return d.drag(e,o)}})}),[d,o]),l=q((function(){return{setProp:function(e,t){t?s.history.throttle(t).setProp(o,e):s.setProp(o,e)},setCustom:function(e,t){t?s.history.throttle(t).setCustom(o,e):s.setCustom(o,e)},setHidden:function(e){return s.setHidden(o,e)}}}),[s,o]);return X(X({},c),{},{id:o,related:a,inNodeContext:!!t,actions:l,connectors:u})}var ge=["id","related","actions","inNodeContext","connectors"];function me(e){var t=ye(e),n=t.id,r=t.related,a=t.actions,i=t.inNodeContext,s=t.connectors;return X(X({},re(t,ge)),{},{actions:a,id:n,related:r,setProp:function(e,t){return o("useNode().setProp()",{suggest:"useNode().actions.setProp()"}),a.setProp(e,t)},inNodeContext:i,connectors:s})}const Ne=({render:e})=>{const{connectors:{connect:t,drag:n}}=me();return"string"==typeof e.type?t(n(A.cloneElement(e))):e},be=()=>{const{type:e,props:t,nodes:n,hydrationTimestamp:r}=ye((e=>({type:e.data.type,props:e.data.props,nodes:e.data.nodes,hydrationTimestamp:e._hydrationTimestamp})));return q((()=>{let r=t.children;n&&n.length>0&&(r=A.createElement(A.Fragment,null,n.map((e=>A.createElement(Oe,{id:e,key:e})))));const o=A.createElement(e,t,r);return"string"==typeof e?A.createElement(Ne,{render:o}):o}),[e,t,r,n])},Ee=({render:e})=>{const{hidden:t}=ye((e=>({hidden:e.data.hidden}))),{onRender:n}=ve((e=>({onRender:e.options.onRender})));return t?null:A.createElement(n,{render:e||A.createElement(be,null)})},Oe=({id:e,render:t})=>A.createElement(U,{id:e},A.createElement(Ee,{render:t})),we={is:"div",canvas:!1,custom:{},hidden:!1},Te={is:"type",canvas:"isCanvas"};function Ce({id:e,children:t,...n}){const{is:r}={...we,...n},{query:o,actions:i}=ve(),{id:s,inNodeContext:d}=ye(),[c]=F((()=>{H(!!e,a);const c=o.node(s).get();if(d){const a=c.data.linkedNodes[e]?o.node(c.data.linkedNodes[e]).get():null;if(a&&a.data.type===r)return a.id;const d=A.createElement(Ce,n,t),u=o.parseReactElement(d).toNodeTree();return i.history.ignore().addLinkedNodeFromTree(u,s,e),u.rootNodeId}return null}));return c?A.createElement(Oe,{id:c}):null}const ke=()=>o("<Canvas />",{suggest:"<Element canvas={true} />"});function Canvas({...e}){return _((()=>ke()),[]),A.createElement(Ce,{...e,canvas:!0})}const Se=()=>{const{timestamp:e}=ve((e=>({timestamp:e.nodes[i]&&e.nodes[i]._hydrationTimestamp})));return e?A.createElement(Oe,{id:i,key:e}):null},je=({children:e,json:t,data:n})=>{const{actions:r,query:a}=ve();t&&o("<Frame json={...} />",{suggest:"<Frame data={...} />"});const s=M(!1);if(!s.current){const o=n||t;if(o)r.history.ignore().deserialize(o);else if(e){const t=A.Children.only(e),n=a.parseReactElement(t).toNodeTree(((e,n)=>(n===t&&(e.id=i),e)));r.history.ignore().addNodeTree(n)}s.current=!0}return A.createElement(Se,null)};var De;!function(e){e[e.Any=0]="Any",e[e.Id=1]="Id",e[e.Obj=2]="Obj"}(De||(De={}));const Ie=e=>{const{addLinkedNodeFromTree:t,setDOM:n,setNodeEvent:r,replaceNodes:o,reset:a,...i}=e;return i};function xe(e){const{connectors:t,actions:n,query:r,store:o,...a}=ve(e),i=Ie(n);return{connectors:t,actions:q((()=>({...i,history:{...i.history,ignore:(...e)=>Ie(i.history.ignore(...e)),throttle:(...e)=>Ie(i.history.throttle(...e))}})),[i]),query:r,store:o,...a}}function Pe(e){return t=>n=>{const r=e?xe(e):xe();return A.createElement(t,{...r,...n})}}function Ae(e){return function(t){return n=>{const r=me(e);return A.createElement(t,{...r,...n})}}}var Le=function(e){return Object.fromEntries?Object.fromEntries(e):e.reduce((function(e,t){var n=ie(t,2),r=n[0],o=n[1];return X(X({},e),{},Z({},r,o))}),{})},Re=function(e,t,n){var r=Array.isArray(t)?t:[t],o=X({existOnly:!1,idOnly:!1},n||{}),a=r.filter((function(e){return!!e})).map((function(t){return"string"==typeof t?{node:e[t],exists:!!e[t]}:"object"!==Y(t)||o.idOnly?{node:null,exists:!1}:{node:t,exists:!!e[t.id]}}));return o.existOnly&&H(0===a.filter((function(e){return!e.exists})).length,s),a},qe=["history"],_e=null,Fe=function(e,t){if("string"==typeof t)return t;var n,r=function(e,t){var n=function(e){if(_e&&_e.resolver===e)return _e.reversed;_e={resolver:e,reversed:new Map};for(var t=0,n=Object.entries(e);t<n.length;t++){var r=ie(n[t],2);_e.reversed.set(r[1],r[0])}return _e.reversed}(e).get(t);return void 0!==n?n:null}(e,t);return H(r,l.replace("%node_type%",(n=t).name||n.displayName)),r};const Me=(e,t)=>"string"==typeof e?e:{resolvedName:Fe(t,e)},ze=(e,t)=>{let{type:n,isCanvas:r,props:o}=e;return o=Object.keys(o).reduce(((e,n)=>{const r=o[n];return null==r||"function"==typeof r||(e[n]="children"===n&&"string"!=typeof r?z.map(r,(e=>"string"==typeof e?e:ze(e,t))):"function"==typeof r.type?ze(r,t):r),e}),{}),{type:Me(n,t),isCanvas:!!r,props:o}},Be=(e,t)=>{const{type:n,props:r,isCanvas:o,name:a,...i}=e;return{...ze({type:n,isCanvas:o,props:r},t),...i}};function He(e,t){H("string"==typeof t,f);var n=e.nodes[t],r=function(t){return He(e,t)};return{isCanvas:function(){return!!n.data.isCanvas},isRoot:function(){return n.id===i},isLinkedNode:function(){return n.data.parent&&r(n.data.parent).linkedNodes().includes(n.id)},isTopLevelNode:function(){return this.isRoot()||this.isLinkedNode()},isDeletable:function(){return!this.isTopLevelNode()},isParentOfTopLevelNodes:function(){return n.data.linkedNodes&&Object.keys(n.data.linkedNodes).length>0},isParentOfTopLevelCanvas:function(){return o("query.node(id).isParentOfTopLevelCanvas",{suggest:"query.node(id).isParentOfTopLevelNodes"}),this.isParentOfTopLevelNodes()},isSelected:function(){return e.events.selected.has(t)},isHovered:function(){return e.events.hovered.has(t)},isDragged:function(){return e.events.dragged.has(t)},get:function(){return n},ancestors:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function n(r){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=e.nodes[r];return i?(o.push(r),i.data.parent?((t||!t&&0===a)&&(o=n(i.data.parent,o,a+1)),o):o):o}(n.data.parent)},descendants:function(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=arguments.length>1?arguments[1]:void 0;return function t(a){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return(n||!n&&0===s)&&e.nodes[a]?("childNodes"!==o&&r(a).linkedNodes().forEach((function(e){i.push(e),i=t(e,i,s+1)})),"linkedNodes"!==o&&r(a).childNodes().forEach((function(e){i.push(e),i=t(e,i,s+1)})),i):i}(t)},linkedNodes:function(){return Object.values(n.data.linkedNodes||{})},childNodes:function(){return n.data.nodes||[]},isDraggable:function(t){try{var o=n;return H(!this.isTopLevelNode(),p),H(He(e,o.data.parent).isCanvas(),v),H(o.rules.canDrag(o,r),h),!0}catch(e){return t&&t(e),!1}},isDroppable:function(t,o){var a=Re(e.nodes,t),i=n;try{H(this.isCanvas(),y),H(i.rules.canMoveIn(a.map((function(e){return e.node})),i,r),g);var s={};return a.forEach((function(t){var n=t.node,o=t.exists;if(H(n.rules.canDrop(i,n,r),m),o){H(!r(n.id).isTopLevelNode(),p);var a=r(n.id).descendants(!0);H(!a.includes(i.id)&&i.id!==n.id,N);var d=n.data.parent&&e.nodes[n.data.parent];H(d.data.isCanvas,v),H(d||!d&&!e.nodes[n.id],b),d.id!==i.id&&(s[d.id]||(s[d.id]=[]),s[d.id].push(n))}})),Object.keys(s).forEach((function(t){var n=e.nodes[t];H(n.rules.canMoveOut(s[t],n,r),E)})),!0}catch(e){return o&&o(e),!1}},toSerializedNode:function(){return Be(n.data,e.options.resolver)},toNodeTree:function(e){var n=[t].concat(se(this.descendants(!0,e))).reduce((function(e,t){return e[t]=r(t).get(),e}),{});return{rootNodeId:t,nodes:n}},decendants:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return o("query.node(id).decendants",{suggest:"query.node(id).descendants"}),this.descendants(e)},isTopLevelCanvas:function(){return!this.isRoot()&&!n.data.parent}}}function $e(e,t,n,r){for(var o={parent:e,index:0,where:"before"},a=0,i=0,s=0,d=0,c=0,u=0,l=0,f=t.length;l<f;l++){var p=t[l];if(u=p.top+p.outerHeight,d=p.left+p.outerWidth/2,c=p.top+p.outerHeight/2,!(i&&p.left>i||s&&c>=s||a&&p.left+p.outerWidth<a))if(o.index=l,p.inFlow){if(r<c){o.where="before";break}o.where="after"}else r<u&&(s=u),n<d?(i=d,o.where="before"):(a=d,o.where="after")}return o}var Je=function(e){return"string"==typeof e?e:e.name};function We(e,t){var n=e.data.type,r={id:e.id||O(),_hydrationTimestamp:Date.now(),data:X({type:n,name:Je(n),displayName:Je(n),props:{},custom:{},parent:null,isCanvas:!1,hidden:!1,nodes:[],linkedNodes:{}},e.data),info:{},related:{},events:{selected:!1,dragged:!1,hovered:!1},rules:{canDrag:function(){return!0},canDrop:function(){return!0},canMoveIn:function(){return!0},canMoveOut:function(){return!0}},dom:null};if(r.data.type===Ce||r.data.type===Canvas){var o=X(X({},we),r.data.props);r.data.props=Object.keys(r.data.props).reduce((function(e,t){return Object.keys(we).includes(t)?r.data[Te[t]||t]=o[t]:e[t]=r.data.props[t],e}),{}),r.data.name=Je(n=r.data.type),r.data.displayName=Je(n),r.data.type===Canvas&&(r.data.isCanvas=!0,ke())}t&&t(r);var a=n.craft;if(a){if(r.data.displayName=a.displayName||a.name||r.data.displayName,r.data.props=X(X({},a.props||a.defaultProps||{}),r.data.props),r.data.custom=X(X({},a.custom||{}),r.data.custom),null!=a.isCanvas&&(r.data.isCanvas=a.isCanvas),a.rules&&Object.keys(a.rules).forEach((function(e){["canDrag","canDrop","canMoveIn","canMoveOut"].includes(e)&&(r.rules[e]=a.rules[e])})),a.related){var i={id:r.id,related:!0};Object.keys(a.related).forEach((function(e){r.related[e]=function(t){return A.createElement(U,i,A.createElement(a.related[e],t))}}))}a.info&&(r.info=a.info)}return r}const Ue=(e,t,n)=>{let{type:r,props:o}=e;const a=((e,t)=>"object"==typeof e&&e.resolvedName?"Canvas"===e.resolvedName?Canvas:t[e.resolvedName]:"string"==typeof e?e:null)(r,t);if(!a)return;o=Object.keys(o).reduce(((e,n)=>{const r=o[n];return e[n]=null==r?null:"object"==typeof r&&r.resolvedName?Ue(r,t):"children"===n&&Array.isArray(r)?r.map((e=>"string"==typeof e?e:Ue(e,t))):r,e}),{}),n&&(o.key=n);const i={...A.createElement(a,{...o})};return{...i,name:Fe(t,i.type)}},Ve=(e,t)=>{const{type:n,props:r,...o}=e;H(void 0!==n&&"string"==typeof n||void 0!==n&&void 0!==n.resolvedName,w.replace("%displayName%",e.displayName).replace("%availableComponents%",Object.keys(t).join(", ")));const{type:a,name:i,props:s}=Ue(e,t),{parent:d,custom:c,displayName:u,isCanvas:l,nodes:f,hidden:p}=o;return{type:a,name:i,displayName:u||i,props:s,custom:c||{},isCanvas:!!l,hidden:!!p,parent:d,linkedNodes:o.linkedNodes||o._childCanvas||{},nodes:f||[]}},Xe=(e,t)=>{if(t.length<1)return{[e.id]:e};const n=t.map((({rootNodeId:e})=>e)),r={...e,data:{...e.data,nodes:n}};return t.reduce(((t,n)=>{const r=n.nodes[n.rootNodeId];return{...t,...n.nodes,[r.id]:{...r,data:{...r.data,parent:e.id}}}}),{[e.id]:r})},Ye=(e,t)=>({rootNodeId:e.id,nodes:Xe(e,t)});function Ge(e){const t=e&&e.options,n=()=>Ge(e);return{getDropPlaceholder:(t,r,o,a=(t=>e.nodes[t.id].dom))=>{const i=e.nodes[r],s=n().node(i.id).isCanvas()?i:e.nodes[i.data.parent];if(!s)return;const d=s.data.nodes||[],c=$e(s,d?d.reduce(((t,n)=>{const r=a(e.nodes[n]);if(r){const e={id:n,...T(r)};t.push(e)}return t}),[]):[],o.x,o.y),u=d.length&&e.nodes[d[c.index]],l={placement:{...c,currentNode:u},error:null};return Re(e.nodes,t).forEach((({node:e,exists:t})=>{t&&n().node(e.id).isDraggable((e=>l.error=e))})),n().node(s.id).isDroppable(t,(e=>l.error=e)),l},getOptions:()=>t,getNodes:()=>e.nodes,node:t=>He(e,t),getSerializedNodes(){const t=Object.keys(e.nodes).map((e=>[e,this.node(e).toSerializedNode()]));return Le(t)},getEvent:t=>function(e,t){var n=e.events[t];return{contains:function(e){return n.has(e)},isEmpty:function(){return 0===this.all().length},first:function(){return this.all()[0]},last:function(){var e=this.all();return e[e.length-1]},all:function(){return Array.from(n)},size:function(){return this.all().length},at:function(e){return this.all()[e]},raw:function(){return n}}}(e,t),serialize(){return JSON.stringify(this.getSerializedNodes())},parseReactElement:t=>({toNodeTree(r){let o=function(e,t){let n=e;return"string"==typeof n&&(n=A.createElement(B,{},n)),We({data:{type:n.type,props:{...n.props}}},(e=>{t&&t(e,n)}))}(t,((t,n)=>{const o=Fe(e.options.resolver,t.data.type);t.data.displayName=t.data.displayName||o,t.data.name=o,r&&r(t,n)})),a=[];return t.props&&t.props.children&&(a=A.Children.toArray(t.props.children).reduce(((e,t)=>(A.isValidElement(t)&&e.push(n().parseReactElement(t).toNodeTree(r)),e)),[])),Ye(o,a)}}),parseSerializedNode:t=>({toNode(r){const a=Ve(t,e.options.resolver);H(a.type,l);const i="string"==typeof r&&r;return i&&o("query.parseSerializedNode(...).toNode(id)",{suggest:"query.parseSerializedNode(...).toNode(node => node.id = id)"}),n().parseFreshNode({...i?{id:i}:{},data:a}).toNode(!i&&r)}}),parseFreshNode:t=>({toNode:n=>We(t,(t=>{t.data.parent===u&&(t.data.parent=i);const r=Fe(e.options.resolver,t.data.type);H(null!==r,l),t.data.displayName=t.data.displayName||r,t.data.name=r,n&&n(t)}))}),createNode(e,t){o(`query.createNode(${e})`,{suggest:`query.parseReactElement(${e}).toNodeTree()`});const n=this.parseReactElement(e).toNodeTree(),r=n.nodes[n.rootNodeId];return t?(t.id&&(r.id=t.id),t.data&&(r.data={...r.data,...t.data}),r):r},getState:()=>e}}var Ke=function(e){ee(n,C);var t=ae(n);function n(){return G(this,n),t.apply(this,arguments)}return Q(n,[{key:"handlers",value:function(){return{connect:function(e,t){},select:function(e,t){},hover:function(e,t){},drag:function(e,t){},drop:function(e,t){},create:function(e,t,n){}}}}]),n}(),Qe=function(e){ee(n,k);var t=ae(n);function n(){return G(this,n),t.apply(this,arguments)}return Q(n)}(),Ze=function(e){e.preventDefault()},et=function(){function e(t,n){G(this,e),Z(this,"store",void 0),Z(this,"dragTarget",void 0),Z(this,"currentDropTargetId",void 0),Z(this,"currentDropTargetCanvasAncestorId",void 0),Z(this,"currentIndicator",null),Z(this,"currentTargetId",void 0),Z(this,"currentTargetChildDimensions",void 0),Z(this,"dragError",void 0),Z(this,"draggedNodes",void 0),Z(this,"onScrollListener",void 0),this.store=t,this.dragTarget=n,this.currentDropTargetId=null,this.currentDropTargetCanvasAncestorId=null,this.currentTargetId=null,this.currentTargetChildDimensions=null,this.currentIndicator=null,this.dragError=null,this.draggedNodes=this.getDraggedNodes(),this.validateDraggedNodes(),this.onScrollListener=this.onScroll.bind(this),window.addEventListener("scroll",this.onScrollListener,!0),window.addEventListener("dragover",Ze,!1)}return Q(e,[{key:"cleanup",value:function(){window.removeEventListener("scroll",this.onScrollListener,!0),window.removeEventListener("dragover",Ze,!1)}},{key:"onScroll",value:function(e){var t=e.target,n=this.store.query.node(i).get();t instanceof Element&&n&&n.dom&&t.contains(n.dom)&&(this.currentTargetChildDimensions=null)}},{key:"getDraggedNodes",value:function(){return Re(this.store.query.getNodes(),"new"===this.dragTarget.type?this.dragTarget.tree.nodes[this.dragTarget.tree.rootNodeId]:this.dragTarget.nodes)}},{key:"validateDraggedNodes",value:function(){var e=this;"new"!==this.dragTarget.type&&this.draggedNodes.forEach((function(t){t.exists&&e.store.query.node(t.node.id).isDraggable((function(t){e.dragError=t}))}))}},{key:"isNearBorders",value:function(t,n,r){return t.top+e.BORDER_OFFSET>r||t.bottom-e.BORDER_OFFSET<r||t.left+e.BORDER_OFFSET>n||t.right-e.BORDER_OFFSET<n}},{key:"isDiff",value:function(e){return!this.currentIndicator||this.currentIndicator.placement.parent.id!==e.parent.id||this.currentIndicator.placement.index!==e.index||this.currentIndicator.placement.where!==e.where}},{key:"getChildDimensions",value:function(e){var t=this,n=this.currentTargetChildDimensions;return this.currentTargetId===e.id&&n?n:e.data.nodes.reduce((function(e,n){var r=t.store.query.node(n).get().dom;return r&&e.push(X({id:n},T(r))),e}),[])}},{key:"getCanvasAncestor",value:function(e){var t=this;if(e===this.currentDropTargetId&&this.currentDropTargetCanvasAncestorId){var n=this.store.query.node(this.currentDropTargetCanvasAncestorId).get();if(n)return n}return function e(n){var r=t.store.query.node(n).get();return r&&r.data.isCanvas?r:r.data.parent?e(r.data.parent):null}(e)}},{key:"computeIndicator",value:function(e,t,n){var r=this.getCanvasAncestor(e);if(r&&(this.currentDropTargetId=e,this.currentDropTargetCanvasAncestorId=r.id,r.data.parent&&this.isNearBorders(T(r.dom),t,n)&&!this.store.query.node(r.id).isLinkedNode()&&(r=this.store.query.node(r.data.parent).get()),r)){this.currentTargetChildDimensions=this.getChildDimensions(r),this.currentTargetId=r.id;var o=$e(r,this.currentTargetChildDimensions,t,n);if(this.isDiff(o)){var a=this.dragError;a||this.store.query.node(r.id).isDroppable(this.draggedNodes.map((function(e){return e.node})),(function(e){a=e}));var i=r.data.nodes[o.index],s=i&&this.store.query.node(i).get();return this.currentIndicator={placement:X(X({},o),{},{currentNode:s}),error:a},this.currentIndicator}}}},{key:"getIndicator",value:function(){return this.currentIndicator}}]),e}();Z(et,"BORDER_OFFSET",10);var tt=function(e,t){if(1===t.length||arguments.length>2&&void 0!==arguments[2]&&arguments[2]){var n=t[0].getBoundingClientRect(),r=n.width,o=n.height,a=t[0].cloneNode(!0);return a.style.position="absolute",a.style.left="-100%",a.style.top="-100%",a.style.width="".concat(r,"px"),a.style.height="".concat(o,"px"),a.style.pointerEvents="none",a.classList.add("drag-shadow"),document.body.appendChild(a),e.dataTransfer.setDragImage(a,0,0),a}var i=document.createElement("div");return i.style.position="absolute",i.style.left="-100%",i.style.top="-100%",i.style.width="100%",i.style.height="100%",i.style.pointerEvents="none",i.classList.add("drag-shadow-container"),t.forEach((function(e){var t=e.getBoundingClientRect(),n=t.width,r=t.height,o=t.top,a=t.left,s=e.cloneNode(!0);s.style.position="absolute",s.style.left="".concat(a,"px"),s.style.top="".concat(o,"px"),s.style.width="".concat(n,"px"),s.style.height="".concat(r,"px"),s.classList.add("drag-shadow"),i.appendChild(s)})),document.body.appendChild(i),e.dataTransfer.setDragImage(i,e.clientX,e.clientY),i},nt=function(e){ee(n,Ke);var t=ae(n);function n(){var e;G(this,n);for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return Z(oe(e=t.call.apply(t,[this].concat(o))),"draggedElementShadow",void 0),Z(oe(e),"dragTarget",void 0),Z(oe(e),"positioner",null),Z(oe(e),"currentSelectedElementIds",[]),e}return Q(n,[{key:"onDisable",value:function(){this.options.store.actions.clearEvents()}},{key:"handlers",value:function(){var e=this,t=this.options.store;return{connect:function(n,r){return t.actions.setDOM(r,n),e.reflect((function(e){e.select(n,r),e.hover(n,r),e.drop(n,r)}))},select:function(n,r){var o=e.addCraftEventListener(n,"mousedown",(function(n){n.craft.stopPropagation();var o=[];if(r){var a=t.query,i=a.getEvent("selected").all();(e.options.isMultiSelectEnabled(n)||i.includes(r))&&(o=i.filter((function(e){var t=a.node(e).descendants(!0),n=a.node(e).ancestors(!0);return!t.includes(r)&&!n.includes(r)}))),o.includes(r)||o.push(r)}t.actions.setNodeEvent("selected",o)})),a=e.addCraftEventListener(n,"click",(function(n){n.craft.stopPropagation();var o=t.query.getEvent("selected").all(),a=e.options.isMultiSelectEnabled(n),i=e.currentSelectedElementIds.includes(r),s=se(o);a&&i?(s.splice(s.indexOf(r),1),t.actions.setNodeEvent("selected",s)):!a&&o.length>1&&t.actions.setNodeEvent("selected",s=[r]),e.currentSelectedElementIds=s}));return function(){o(),a()}},hover:function(n,r){var o=e.addCraftEventListener(n,"mouseover",(function(e){e.craft.stopPropagation(),t.actions.setNodeEvent("hovered",r)}));return e.options.removeHoverOnMouseleave&&e.addCraftEventListener(n,"mouseleave",(function(e){e.craft.stopPropagation(),t.actions.setNodeEvent("hovered",null)})),function(){o()}},drop:function(n,r){var o=e.addCraftEventListener(n,"dragover",(function(n){if(n.craft.stopPropagation(),n.preventDefault(),e.positioner){var o=e.positioner.computeIndicator(r,n.clientX,n.clientY);o&&t.actions.setIndicator(o)}})),a=e.addCraftEventListener(n,"dragenter",(function(e){e.craft.stopPropagation(),e.preventDefault()}));return function(){a(),o()}},drag:function(r,o){if(!t.query.node(o).isDraggable())return function(){};r.setAttribute("draggable","true");var a=e.addCraftEventListener(r,"dragstart",(function(r){r.craft.stopPropagation();var a=t.query,i=t.actions,s=a.getEvent("selected").all(),d=e.options.isMultiSelectEnabled(r);e.currentSelectedElementIds.includes(o)||(s=d?[].concat(se(s),[o]):[o],t.actions.setNodeEvent("selected",s)),i.setNodeEvent("dragged",s);var c=s.map((function(e){return a.node(e).get().dom}));e.draggedElementShadow=tt(r,c,n.forceSingleDragShadow),e.dragTarget={type:"existing",nodes:s},e.positioner=new et(e.options.store,e.dragTarget)})),i=e.addCraftEventListener(r,"dragend",(function(n){n.craft.stopPropagation(),e.dropElement((function(e,n){"new"!==e.type&&t.actions.move(e.nodes,n.placement.parent.id,n.placement.index+("after"===n.placement.where?1:0))}))}));return function(){r.setAttribute("draggable","false"),a(),i()}},create:function(r,o,a){r.setAttribute("draggable","true");var i=e.addCraftEventListener(r,"dragstart",(function(r){var a;if(r.craft.stopPropagation(),"function"==typeof o){var i=o();a=A.isValidElement(i)?t.query.parseReactElement(i).toNodeTree():i}else a=t.query.parseReactElement(o).toNodeTree();e.draggedElementShadow=tt(r,[r.currentTarget],n.forceSingleDragShadow),e.dragTarget={type:"new",tree:a},e.positioner=new et(e.options.store,e.dragTarget)})),s=e.addCraftEventListener(r,"dragend",(function(n){n.craft.stopPropagation(),e.dropElement((function(e,n){"existing"!==e.type&&(t.actions.addNodeTree(e.tree,n.placement.parent.id,n.placement.index+("after"===n.placement.where?1:0)),a&&$(a.onCreate)&&a.onCreate(e.tree))}))}));return function(){r.removeAttribute("draggable"),i(),s()}}}}},{key:"dropElement",value:function(e){var t=this.options.store;if(this.positioner){var n=this.draggedElementShadow,r=this.positioner.getIndicator();this.dragTarget&&r&&!r.error&&e(this.dragTarget,r),n&&(n.parentNode.removeChild(n),this.draggedElementShadow=null),this.dragTarget=null,t.actions.setIndicator(null),t.actions.setNodeEvent("dragged",null),this.positioner.cleanup(),this.positioner=null}}}]),n}();function rt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,o=0,a=0,i=0,s=0,d=e.where;return n?n.inFlow?(i=n.outerWidth,s=r,o="before"===d?n.top:n.bottom,a=n.left):(i=r,s=n.outerHeight,o=n.top,a="before"===d?n.left:n.left+n.outerWidth):t&&(o=t.top+t.padding.top,a=t.left+t.padding.left,i=t.outerWidth-t.padding.right-t.padding.left-t.margin.left-t.margin.right,s=r),{top:"".concat(o,"px"),left:"".concat(a,"px"),width:"".concat(i,"px"),height:"".concat(s,"px")}}Z(nt,"forceSingleDragShadow",S()&&j());const ot=()=>{const{indicator:e,indicatorOptions:t,enabled:n}=ve((e=>({indicator:e.indicator,indicatorOptions:e.options.indicator,enabled:e.options.enabled}))),r=pe();return _((()=>{r&&(n?r.enable():r.disable())}),[n,r]),e?A.createElement(D,{className:t.className,style:{...rt(e.placement,T(e.placement.parent.dom),e.placement.currentNode&&T(e.placement.currentNode.dom),t.thickness),backgroundColor:e.error?t.error:t.success,transition:t.transition||"0.2s ease-in",...t.style??{}},parentDom:e.placement.parent.dom}):null},at=({children:e})=>{const t=R(le),n=q((()=>t.query.getOptions().handlers(t)),[t]);return n?A.createElement(fe.Provider,{value:n},A.createElement(ot,null),e):null},it={nodes:{},events:{dragged:new Set,selected:new Set,hovered:new Set},indicator:null,options:{onNodesChange:()=>null,onRender:({render:e})=>e,onBeforeMoveEnd:()=>null,resolver:{},enabled:!0,indicator:{error:"red",success:"rgb(98, 196, 98)"},handlers:e=>new nt({store:e,removeHoverOnMouseleave:!1,isMultiSelectEnabled:e=>!!e.metaKey}),normalizeNodes:()=>{}}},st={methods:function(e,t){return X(X({},function(e,t){var n=function(t,n,o){if(function n(r,o){var a=t.nodes[r];"string"!=typeof a.data.type&&H(e.options.resolver[a.data.name],l.replace("%node_type%","".concat(a.data.type.name))),e.nodes[r]=X(X({},a),{},{data:X(X({},a.data),{},{parent:o})}),a.data.nodes.length>0&&(delete e.nodes[r].data.props.children,a.data.nodes.forEach((function(e){return n(e,a.id)}))),Object.values(a.data.linkedNodes).forEach((function(e){return n(e,a.id)}))}(t.rootNodeId,n),n||t.rootNodeId!==i){var a=r(n);if("child"!==o.type)a.data.linkedNodes[o.id]=t.rootNodeId;else{var s=o.index;null!=s?a.data.nodes.splice(s,0,t.rootNodeId):a.data.nodes.push(t.rootNodeId)}}},r=function(t){H(t,c);var n=e.nodes[t];return H(n,s),n},a=function t(n){var r=e.nodes[n],o=e.nodes[r.data.parent];if(r.data.nodes&&se(r.data.nodes).forEach((function(e){return t(e)})),r.data.linkedNodes&&Object.values(r.data.linkedNodes).map((function(e){return t(e)})),o.data.nodes.includes(n)){var a=o.data.nodes;a.splice(a.indexOf(n),1)}else{var i=Object.keys(o.data.linkedNodes).find((function(e){return o.data.linkedNodes[e]===e}));i&&delete o.data.linkedNodes[i]}!function(e,t){Object.keys(e.events).forEach((function(n){var r=e.events[n];r&&r.has&&r.has(t)&&(e.events[n]=new Set(Array.from(r).filter((function(e){return t!==e}))))}))}(e,n),delete e.nodes[n]};return{addLinkedNodeFromTree:function(e,t,o){var i=r(t).data.linkedNodes[o];i&&a(i),n(e,t,{type:"linked",id:o})},add:function(e,t,r){var a=[e];Array.isArray(e)&&(o("actions.add(node: Node[])",{suggest:"actions.add(node: Node)"}),a=e),a.forEach((function(e){n({nodes:Z({},e.id,e),rootNodeId:e.id},t,{type:"child",index:r})}))},addNodeTree:function(e,t,r){n(e,t,{type:"child",index:r})},delete:function(n){Re(e.nodes,n,{existOnly:!0,idOnly:!0}).forEach((function(e){var n=e.node;H(!t.node(n.id).isTopLevelNode(),d),a(n.id)}))},deserialize:function(e){var n="string"==typeof e?JSON.parse(e):e,r=Object.keys(n).map((function(e){var r=e;return e===u&&(r=i),[r,t.parseSerializedNode(n[e]).toNode((function(e){return e.id=r}))]}));this.replaceNodes(Le(r))},move:function(n,r,o){var a=Re(e.nodes,n,{existOnly:!0}),i=e.nodes[r],s=new Set;a.forEach((function(n,a){var d=n.node,c=d.id,u=d.data.parent;t.node(r).isDroppable([c],(function(e){throw new Error(e)})),e.options.onBeforeMoveEnd(d,i,e.nodes[u]);var l=e.nodes[u].data.nodes;s.add(l);var f=l.indexOf(c);l[f]="$$",i.data.nodes.splice(o+a,0,c),e.nodes[c].data.parent=r})),s.forEach((function(e){var t=e.length;se(e).reverse().forEach((function(n,r){"$$"===n&&e.splice(t-1-r,1)}))}))},replaceNodes:function(t){this.clearEvents(),e.nodes=t},clearEvents:function(){this.setNodeEvent("selected",null),this.setNodeEvent("hovered",null),this.setNodeEvent("dragged",null),this.setIndicator(null)},reset:function(){this.clearEvents(),this.replaceNodes({})},setOptions:function(t){t(e.options)},setNodeEvent:function(t,n){if(e.events[t].forEach((function(n){e.nodes[n]&&(e.nodes[n].events[t]=!1)})),e.events[t]=new Set,n){var r=Re(e.nodes,n,{idOnly:!0,existOnly:!0}),o=new Set(r.map((function(e){return e.node.id})));o.forEach((function(n){e.nodes[n].events[t]=!0})),e.events[t]=o}},setCustom:function(t,n){Re(e.nodes,t,{idOnly:!0,existOnly:!0}).forEach((function(t){return n(e.nodes[t.node.id].data.custom)}))},setDOM:function(t,n){e.nodes[t]&&(e.nodes[t].dom=n)},setIndicator:function(t){t&&(!t.placement.parent.dom||t.placement.currentNode&&!t.placement.currentNode.dom)||(e.indicator=t)},setHidden:function(t,n){e.nodes[t].data.hidden=n},setProp:function(t,n){Re(e.nodes,t,{idOnly:!0,existOnly:!0}).forEach((function(t){return n(e.nodes[t.node.id].data.props)}))},selectNode:function(t){if(t){var n=Re(e.nodes,t,{idOnly:!0,existOnly:!0});this.setNodeEvent("selected",n.map((function(e){return e.node.id})))}else this.setNodeEvent("selected",null);this.setNodeEvent("hovered",null)}}}(e,t)),{},{setState:function(t){var n=re(this,qe);t(e,n)}})},ignoreHistoryForActions:["setDOM","setNodeEvent","selectNode","clearEvents","setOptions","setIndicator"],normalizeHistory:e=>{Object.keys(e.events).forEach((t=>{Array.from(e.events[t]||[]).forEach((n=>{e.nodes[n]||e.events[t].delete(n)}))})),Object.keys(e.nodes).forEach((t=>{const n=e.nodes[t];Object.keys(n.events).forEach((t=>{n.events[t]&&e.events[t]&&!e.events[t].has(n.id)&&(n.events[t]=!1)}))}))}},dt=(e,t)=>I(st,{...it,options:{...it.options,...e}},Ge,t),ct=({children:e,...t})=>{void 0!==t.resolver&&H("object"==typeof t.resolver&&!Array.isArray(t.resolver)&&null!==t.resolver,x);const n=M(t),r=dt(n.current,((e,t,n,r,o)=>{if(!n)return;const{patches:a,...i}=n;for(let n=0;n<a.length;n++){const{path:s}=a[n],d=s.length>2&&"nodes"===s[0]&&"data"===s[2];if([P.IGNORE,P.THROTTLE].includes(i.type)&&i.params&&(i.type=i.params[0]),["setState","deserialize"].includes(i.type)||d){o((n=>{e.options.normalizeNodes&&e.options.normalizeNodes(n,t,i,r)}));break}}}));return _((()=>{r&&void 0!==t.enabled&&r.query.getOptions().enabled!==t.enabled&&r.actions.setOptions((e=>{e.enabled=t.enabled}))}),[r,t.enabled]),_((()=>{r.subscribe((e=>({json:r.query.serialize()})),(()=>{r.query.getOptions().onNodesChange(r.query)}))}),[r]),r?A.createElement(le.Provider,{value:r},A.createElement(at,null,e)):null};var ut=["events","data"],lt=["nodes"],ft=["nodes"],pt=["_hydrationTimestamp","rules"],vt=["_hydrationTimestamp","rules"],ht=function(e){var t=e.events,n=e.data,r=n.nodes,o=n.linkedNodes,a=re(e,ut),i=We(J(e));return{node:e=X(X(X({},i),a),{},{events:X(X({},i.events),t),dom:e.dom||i.dom}),childNodes:r,linkedNodes:o}},yt=function(e,t){var n=t.nodes,r=re(t,lt),o=e.nodes,a=re(e,ft);expect(a).toEqual(r);var i=Object.keys(n).reduce((function(e,t){var r=re(n[t],pt);return e[t]=r,e}),{}),s=Object.keys(o).reduce((function(e,t){var n=re(o[t],vt);return e[t]=n,e}),{});expect(s).toEqual(i)},gt=function(e){var t={};return function e(n){var r=ht(n),o=r.node,a=r.childNodes,i=r.linkedNodes;t[o.id]=o,a&&a.forEach((function(n,r){var a=ht(n),i=a.node,s=a.childNodes,d=a.linkedNodes;i.data.parent=o.id,t[i.id]=i,o.data.nodes[r]=i.id,e(X(X({},i),{},{data:X(X({},i.data),{},{nodes:s||[],linkedNodes:d||{}})}))})),i&&Object.keys(i).forEach((function(n){var r=ht(i[n]),a=r.node,s=r.childNodes,d=r.linkedNodes;o.data.linkedNodes[n]=a.id,a.data.parent=o.id,t[a.id]=a,e(X(X({},a),{},{data:X(X({},a.data),{},{nodes:s||[],linkedNodes:d||{}})}))}))}(e),t},mt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.nodes,n=e.events;return X(X(X({},it),e),{},{nodes:t?gt(t):{},events:X(X({},it.events),n||{})})};export{st as ActionMethodsWithConfig,Canvas,Ke as CoreEventHandlers,nt as DefaultEventHandlers,Qe as DerivedCoreEventHandlers,ct as Editor,Ce as Element,at as Events,je as Frame,Oe as NodeElement,He as NodeHelpers,U as NodeProvider,De as NodeSelectorType,et as Positioner,Ge as QueryMethods,Pe as connectEditor,Ae as connectNode,tt as createShadow,gt as createTestNodes,mt as createTestState,we as defaultElementProps,ke as deprecateCanvasComponent,it as editorInitialState,Te as elementPropToNodeData,yt as expectEditorState,Be as serializeNode,xe as useEditor,dt as useEditorStore,pe as useEventHandler,me as useNode};
//# sourceMappingURL=index.js.map
